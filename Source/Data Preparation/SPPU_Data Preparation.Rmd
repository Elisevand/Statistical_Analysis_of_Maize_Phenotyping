---
title: "SPPU Data Preparation"
author: "Elise"
date: "`r Sys.Date()`"
output: 
  html_document:
    toc: true
    toc_float:
      collapsed: false
      smooth_scroll: false
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_knit$set(root.dir = "C:/Users/elise/Documents/Mémoire/Main/Data/Drive/SPPU")
```

Set the right working directory.
```{r}
setwd("C:/Users/elise/Documents/Mémoire/Main/Data/Drive/SPPU")
```

# Packages importation 

```{r include=FALSE}
rm(list = ls())

library(statgenHTP)
library(ggplot2)
library(gridExtra)
library(dplyr)
library(lubridate)
library(readxl)
library(janitor)
library(flextable)
library(skimr)
library(rstatix)
library(visreg)
library(lsmeans)
library(car)
library(scales)
library(viridis)
library(ggforce)
library(asreml)
library(patchwork)
library(lme4)
library(lmerTest)
library(desplot)
library(purrr)
# Import functions
source("~/Mémoire/functions.R")
```

# 1. Data importation

The first step in this data preparation process involves importing all the pertinent datasets listed in the Google Sheets "Variables template" document. Fist we find the files, then import them.

```{r echo=FALSE}
# List the files
list.files()
```


```{r Data importation, include=FALSE}
test <- read_excel("Rgb1_Morpho_Plant.xlsx")

rgb1 <- read_excel("~/Mémoire/Main/Data/Drive/SPPU/Rgb1_Morpho_Plant.xlsx", 
    col_types = c("date", "date", "numeric", 
        "numeric", "text", "text", "text", 
        "text", "text", "text", "text", "numeric", 
        "numeric", "numeric", "numeric", 
        "numeric", "numeric", "numeric", 
        "numeric", "numeric", "numeric", 
        "numeric"))


rgb2 <- read_excel("~/Mémoire/Main/Data/Drive/SPPU/Rgb2_Morpho_Plant.xlsx", 
    col_types = c("date", "date", "numeric", 
        "numeric", "text", "text", "text", 
        "text", "text", "text", "text", "numeric", 
        "numeric", "numeric", "numeric", 
        "numeric", "numeric", "numeric", 
        "numeric", "numeric", "numeric", 
        "numeric", "numeric"))

data_environment <- read_excel("env_multisensor.xlsx")
```

We can extract the coordinates of each plant with the ISA_EPPN.xlsx dataset, using a made-up function "coordinates_isaTAB".

```{r}
# Get the coordinates
isaTAB <- read_excel("ISA_EPPN2020_SPPU.xlsx", sheet = "s_exp")
coordinates <- coordinates_isaTAB(isaTAB)
```

### A. Datasets structures
We can take a quick look at all the datasets.

- coordinates
- rgb1
- rgb2
- data_environment

```{r Quick look at the datasets}
head(coordinates)
head(rgb1)
head(rgb2)
head(data_environment)
```

### B. Data manipulation

This next step standardizes diverse datasets by renaming variables for consistency, converting data into appropriate units, adding necessary columns, and merging the datasets.


```{r}
################################################################################
# COORDINATES
################################################################################
# Unit.ID 
coordinates$Unit.ID <- seq_len(nrow(coordinates))
# Reference for Sample.Name et Unit.ID
reference <- coordinates[, c("Sample.Name", "Unit.ID")]
## We can then copy dataset2$Unit.ID <- reference$Unit.ID[match(dataset2$Sample.Name, reference$Sample.Name)]

################################################################################
# rgb 1 
################################################################################
# Time, Date and Timestamp
rgb1$Timestamp <- rgb1$`Measuring Time`

rgb1$Date <- sapply(strsplit(as.character(rgb1$Timestamp), split = " "), '[', 1)
rgb1$Time <- sapply(strsplit(as.character(rgb1$Timestamp), split = " "), '[', 2)

# Name of the platform
rgb1$Platform <- "SPPU"

# Unit.ID
rgb1$Unit.ID <- reference$Unit.ID[match(rgb1$`Plant ID`, reference$Sample.Name)]

# Rename the columns for the template
rgb1 <- rename(rgb1,
                           S_Area_pixel = AREA_PX,
                           S_Area_mm_squared = AREA_MM,
                           S_Perimeter_pixel = PERIMETER_PX,
                           S_Perimeter_mm = PERIMETER_MM,
                           S_Compactness = COMPACTNESS,
                           S_Width_pixel = WIDTH_PX,
                           S_Width_mm = WIDTH_MM,
                           S_Height_pixel = HEIGHT_PX,
                           S_Height_mm = HEIGHT_MM
                           )


################################################################################
# rgb2
################################################################################
# Time, Date and Timestamp
rgb2$Timestamp <- rgb2$`Measuring Time`

rgb2$Date <- sapply(strsplit(as.character(rgb2$Timestamp), split = " "), '[', 1)
rgb2$Time <- sapply(strsplit(as.character(rgb2$Timestamp), split = " "), '[', 2)

# Name of the platform
rgb2$Platform <- "SPPU"

# Unit.ID
rgb2$Unit.ID <- reference$Unit.ID[match(rgb2$`Plant ID`, reference$Sample.Name)]

# Rename the columns for the template
rgb2 <- rename(rgb2,
                           T_Area_pixel = AREA_PX,
                           T_Area_mm_squared = AREA_MM,
                           T_Perimeter_pixel = PERIMETER_PX,
                           T_Perimeter_mm = PERIMETER_MM,
                           T_Compactness = COMPACTNESS,
                           T_Roundness = ROUNDNESS,
                           T_Roundness2 = ROUNDNESS2,
                           T_Isotropy = ISOTROPY,
                           T_Eccentricity = ECCENTRICITY,
                           )
rgb2$Rms <- rgb2$RMS
rgb2$Sol <- rgb2$SOL

```

#### Camera angles
For the SPPU platform, the variables in the data_imaging are  measured form 2 different camera angles. It is neccessary to consolidate theses measurements into a single value for each variable for the data analysis steps. 
In this code block, it is done by either taking the maximum of the 2 values or by taking the mean of the 2 values. 

Depending on the variable, the mean or the maximum is taken. The result is stocked in the dataset rgb1_2 and rgb2_2.

| Variable | Mean or maximum |
|:------------:|:-------------------:|
|Height| Mean|
|Area|Maximum|
|Perimeter|Maximum|
|Width|Maximum|
|Convex hull|Maximum|
|Solidity|Maximum|
|Compactness|Maximum|

```{r}
# Data frame containing the results
rgb1_2 <- data.frame()

for (i in seq(1, nrow(rgb1), by = 2)) {
  if (i + 1 <= nrow(rgb1)) {
    row1 <- rgb1[i, ]
    row2 <- rgb1[i + 1, ]

    # Compute the mean or the maximum of the 2 camera angles values
    mean_and_max_row <- data.frame(
      Date = row2$Date, # We keep the important columns
      Time = row2$Time, # We keep the important columns
      Unit.ID = row2$Unit.ID, # We keep the important columns
      Timestamp = row2$Timestamp, # We keep the important columns
      Platform = row2$Platform, # We keep the important columns
      
      S_Area_mm_squared = max(c(as.numeric(row1$S_Area_mm_squared), as.numeric(row2$S_Area_mm_squared))), 
      S_Area_pixel = max(c(as.numeric(row1$S_Area_pixel), as.numeric(row2$S_Area_pixel))),
      
      S_Perimeter_mm = max(c(as.numeric(row1$S_Perimeter_mm), as.numeric(row2$S_Perimeter_mm))),
      S_Perimeter_pixel = max(c(as.numeric(row1$S_Perimeter_pixel), as.numeric(row2$S_Perimeter_pixel))),
      
      
      S_Compactness = max(c(as.numeric(row1$S_Compactness), as.numeric(row2$S_Compactness))),
      
      S_Width_mm = max(c(as.numeric(row1$S_Width_mm), as.numeric(row2$S_Width_mm))),
      S_Width_pixel = max(c(as.numeric(row1$S_Width_pixel), as.numeric(row2$S_Width_pixel))),
      
      
      S_Height_mm = mean(c(as.numeric(row1$S_Height_mm), as.numeric(row2$S_Height_mm))),
      S_Height_pixel = mean(c(as.numeric(row1$S_Height_pixel), as.numeric(row2$S_Height_pixel)))
    )
    
    # Ajouter les résultats au dataframe final
    rgb1_2 <- rbind(rgb1_2, mean_and_max_row)
  }
}

# Afficher le dataframe final
head(rgb1_2)

```

```{r}
# Data frame containing the results
rgb2_2 <- data.frame()

for (i in seq(1, nrow(rgb2), by = 2)) {
  if (i + 1 <= nrow(rgb2)) {
    row1 <- rgb2[i, ]
    row2 <- rgb2[i + 1, ]

    # Compute the mean or the maximum of the 2 camera angles values
    mean_and_max_row <- data.frame(
      Date = row2$Date, # We keep the important columns
      Time = row2$Time, # We keep the important columns
      Unit.ID = row2$Unit.ID, # We keep the important columns
      Timestamp = row2$Timestamp, # We keep the important columns
      Platform = row2$Platform, # We keep the important columns
      
      T_Area_mm_squared = max(c(as.numeric(row1$T_Area_mm_squared), as.numeric(row2$T_Area_mm_squared))), 
      T_Area_pixel = max(c(as.numeric(row1$T_Area_pixel), as.numeric(row2$T_Area_pixel))),
      
      T_Perimeter_mm = max(c(as.numeric(row1$T_Perimeter_mm), as.numeric(row2$T_Perimeter_mm))),
      T_Perimeter_pixel = max(c(as.numeric(row1$T_Perimeter_pixel), as.numeric(row2$T_Perimeter_pixel))),
      
      
      T_Compactness = max(c(as.numeric(row1$T_Compactness), as.numeric(row2$T_Compactness))),
      
      T_Roundness = max(c(as.numeric(row1$T_Roundness), as.numeric(row2$T_Roundness))),
      T_Roundness2 = max(c(as.numeric(row1$T_Roundness2), as.numeric(row2$T_Roundness2))),
      
      
      T_Isotropy = mean(c(as.numeric(row1$T_Isotropy), as.numeric(row2$T_Isotropy))),
      T_Eccentricity = mean(c(as.numeric(row1$T_Eccentricity), as.numeric(row2$T_Eccentricity))),
      
      Rms = mean(c(as.numeric(row1$Rms), as.numeric(row2$Rms))),
      Sol = mean(c(as.numeric(row1$Sol), as.numeric(row2$Sol)))
    )
    
    # Ajouter les résultats au dataframe final
    rgb2_2 <- rbind(rgb2_2, mean_and_max_row)
  }
}

# Afficher le dataframe final
head(rgb2_2)

```


#### Unit conversions
The data template is only in cm, cm² and g. This step converts the data in the right units.

For the SPPU platform, 6 variables are in mm.

```{r}
rgb1_2$S_Height_cm <- 0.01 * rgb1_2$S_Height_mm
rgb1_2$S_Area_cmsquared <- 0.01 * 0.01 * rgb1_2$S_Area_mm_squared
rgb1_2$S_Perimeter_cm <- 0.01 * rgb1_2$S_Perimeter_mm
rgb1_2$S_Width_cm <- 0.01 * rgb1_2$S_Width_mm

rgb2_2$T_Area_cmsquared <- 0.01 * 0.01 * rgb2_2$T_Area_mm_squared
rgb2_2$T_Perimeter_cm <- 0.01 * rgb2_2$T_Perimeter_mm
```

# 2. Data template

### A. Data template: plant_info
This dataset contains information about the plant: Unit.ID, genotype, replication, row and column location in the greenhouse, and soil treatment.

```{r Template plant_info, include=FALSE}
plant_info <- data.frame(Unit.ID = factor(coordinates$Unit.ID),
                 Genotype = factor(isaTAB$`Source Name`),
                 Soil = factor(isaTAB$`Factor Value[e.g. SomeTreatment]`),
                 Replication = factor(coordinates$rep),
                 Row = factor(coordinates$nrow),
                 Column = factor(coordinates$ncol),
                 Platform = "SPPU"
                 )
```

### B. Data template: endpoint
This datasets contains information of the end of the experiment (variables at harvest).
It is then linked by the Unit.ID to the plant_info data template.

```{r Template endpoint, include=FALSE}
endpoint <- data.frame(Unit.ID = NA,
                       Time = NA, 
                       Date = NA,
                       Timestamp = NA,
                       
                       DW_shoot_g = NA,
                       FW_shoot_g = NA,
                       DW_root_g = NA,
                       FW_root_g = NA,
                       Leaf_number= NA,
                       Plant_height_cm = NA,
                       DW_plant_g = NA,
                       Root_length_cm = NA,
                       Root_number = NA,
                       Root_angle = NA,
                       Total_wu = NA,
                       DW_seed_g = NA,
                       FW_seed_g = NA,
                       Leaf_area_cmsquared = NA
)
endpoint <- left_join(endpoint, plant_info, by = "Unit.ID")
```

### C. Data template: timeseries
This section in divided in three data templates: 

- timeseries

- S_timeseries (variables computed from sideview imaging or image processing)

- T_timeseries (variables computed from topview imaging or image processing)

The time interval between data timestamps varies in each platform.
They are then linked by the Unit.ID to the plant_info data template. 


```{r Template timeseries S_timeseries T_timeseries, include=FALSE}

timeseries <- data.frame(Unit.ID = NA,
                         Time = NA,
                         Date = NA,
                         Timestamp = NA,
                         
                         Manual_Plant_height_cm = NA, 
                         Leaf_number = NA,
                         Wue = NA,
                         Plant_biomass = NA,
                         Ligulated_leaf_number = NA,
                         Plant_emergence = NA,
                         Plant_transpiration = NA,
                         Daily_wu = NA,
                         Soil_water_potential = NA
)
timeseries <- left_join(timeseries, plant_info, by = "Unit.ID")
                      

S_timeseries <- data.frame(Unit.ID = factor(rgb1_2$Unit.ID),
                           Timestamp = rgb1_2$Timestamp,
                           Date = date(rgb1_2$Date),
                           Time = rgb1_2$Time,
                           
                           S_Height_cm = as.numeric(rgb1_2$S_Height_cm),
                           S_Height_pixel = as.numeric(rgb1_2$S_Height_pixel),
                           S_Area_cmsquared = as.numeric(rgb1_2$S_Area_cmsquared),
                           S_Area_pixel = as.numeric(rgb1_2$S_Area_pixel),
                           S_Perimeter_cm = as.numeric(rgb1_2$S_Perimeter_cm),
                           S_Perimeter_pixel = as.numeric(rgb1_2$S_Perimeter_pixel),
                           S_Convex_hull_area_cmsquared = NA,
                           S_Solidity = NA,
                           S_Compactness = as.numeric(rgb1_2$S_Compactness),
                           S_Width_cm = as.numeric(rgb1_2$S_Width_cm),
                           S_Width_pixel = as.numeric(rgb1_2$S_Width_pixel),
                           S_Leaf_area_cmsquared = NA
)
S_timeseries <- left_join(S_timeseries, plant_info, by = "Unit.ID")


T_timeseries <- data.frame(Unit.ID = factor(rgb2_2$Unit.ID),
                           Timestamp = rgb2_2$Timestamp,
                           Time = rgb2_2$Time, 
                           Date = date(rgb2_2$Date),
                           
                           T_Area_cm_squared = as.numeric(rgb2_2$T_Area_cmsquared),
                           T_Area_pixel = as.numeric(rgb2_2$T_Area_pixel),
                           T_Perimeter_cm = as.numeric(rgb2_2$T_Perimeter_cm),
                           T_Perimeter_pixel = as.numeric(rgb2_2$T_Perimeter_pixel),
                           T_Convex_hull_area_cmsquared = NA,
                           T_Solidity = NA,
                           T_Compactness = as.numeric(rgb2_2$T_Compactness),
                           T_Roundness = as.numeric(rgb2_2$T_Roundness),
                           T_Roundness2 = as.numeric(rgb2_2$T_Roundness2),
                           T_Isotropy = as.numeric(rgb2_2$T_Isotropy),
                           T_Eccentricity = as.numeric(rgb2_2$T_Eccentricity),
                           T_Rms = as.numeric(rgb2_2$Rms),
                           T_Sol = as.numeric(rgb2_2$Sol)
)
T_timeseries <- left_join(T_timeseries, plant_info, by = "Unit.ID")

```

### D. SPPU data templates

- plant_info
- endpoint
- timeseries
- S_timeseries
- T_timeseries

```{r Data template, echo=FALSE}
head(plant_info)
head(endpoint)
head(timeseries)
head(S_timeseries)
head(T_timeseries)
```

```{r}
# Remplace characters "NaN" by NA values

S_timeseries <- S_timeseries %>%
  mutate_at(vars(4:10), ~ ifelse(. == "NaN", NA, .))
T_timeseries <- T_timeseries %>%
  mutate_at(vars(5:17), ~ ifelse(. == "NaN", NA, .))
```


# 3. Export the data templates in .txt
Stock the new data sets in a new folder.

```{r Export}
setwd("C:/Users/elise/Documents/Mémoire/Main/Data/Templates/SPPU")

write.table(plant_info, file = "plant_info.txt", sep = "\t", row.names = FALSE, quote = FALSE)
write.table(endpoint, file = "endpoint.txt", sep = "\t", row.names = FALSE, quote = FALSE)
write.table(timeseries, file = "timeseries.txt", sep = "\t", row.names = FALSE, quote = FALSE)
write.table(S_timeseries, file = "S_timeseries.txt", sep = "\t", row.names = FALSE, quote = FALSE)
write.table(T_timeseries, file = "T_timeseries.txt", sep = "\t", row.names = FALSE, quote = FALSE)
```














