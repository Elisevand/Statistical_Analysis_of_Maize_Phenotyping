---
title: "4PMI Data Analysis Timepoints"
author: "Elise"
date: "`r Sys.Date()`"
output: 
  html_document:
    toc: true
    toc_float:
      collapsed: false
      smooth_scroll: false 
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_knit$set(root.dir = "C:/Users/elise/Documents/Mémoire/Main/Data/Templates/4PMI")
```

Set the right working directory.

```{r}
setwd("C:/Users/elise/Documents/Mémoire/Main/Data/Templates/4PMI")
```

```{r echo=TRUE, , include=FALSE}
rm(list = ls())

WDIR <- "C:/Users/elise/Documents/Mémoire/Main/Data"
subdir <- 'Extracted'
datadir <- sprintf( '%s/%s', WDIR, subdir)

library(statgenHTP)
library(ggplot2)
library(gridExtra)
library(dplyr)
library(lubridate)
library(readxl)
library(janitor)
library(flextable)
library(skimr)
library(rstatix)
library(visreg)
library(lsmeans)
library(car)
library(scales)
library(viridis)
library(ggforce)
library(asreml)
library(patchwork)
library(lme4)
library(lmerTest)
library(desplot)
# Import functions
source("~/Mémoire/Main/Source/functions.R")
```

# Data importation

Reimport the data sets extracted from the Data Preparation and Data Analysis R Markdown.

```{r}
list.files()

plant_info <- read.table("plant_info.txt", header = TRUE, sep = "\t")
endpoint <- read.table("endpoint.txt", header = TRUE, sep = "\t")

# plant_info
plant_info <- lapply(plant_info, factor)

# endpoint
matching_cols <- intersect(names(endpoint), names(plant_info))
endpoint[, matching_cols] <- lapply(endpoint[, matching_cols], factor)
endpoint$Date <- date(endpoint$Date)
endpoint$Timestamp <- NA

platform <- "4PMI"

# endpoint
df <- endpoint[,colSums(is.na(endpoint))<nrow(endpoint)]
genotype_index <- which(colnames(df) == "Genotype")
variables <- colnames(df[, c(3:(genotype_index - 1))]) # We remove the two first columns that are "Unit.ID" and "Date"

print(paste(platform, ": The variables for endpoint are", paste(variables, collapse = ", "), sep = " "))

endpoint$Plant_type <- substr(endpoint$Genotype, nchar(as.character(endpoint$Genotype)), nchar(as.character(endpoint$Genotype)))
```
Get the cleaned endpoint data

```{r}
endpoint_clean <- endpoint
# Run the function on the dataset for all the variables
endpoint_clean <- detect_replace_outliers_by_genotype(endpoint_clean)
```


# Time point objects

Generation of the timePoints objects using the function "createTimePoints".

```{r}
timePoint_endpoint <- createTimePoints(dat = endpoint,
                                      experimentName = "EPPN2020_4PMI",
                                      genotype = "Genotype",
                                      timePoint = "Date",
                                      plotId = "Unit.ID",
                                      rowNum = "Row",
                                      colNum = "Column",
                                      repId = "Replication")

timePoint_endpoint_clean <- createTimePoints(dat = endpoint_clean,
                                      experimentName = "EPPN2020_4PMI",
                                      genotype = "Genotype",
                                      timePoint = "Date",
                                      plotId = "Unit.ID",
                                      rowNum = "Row",
                                      colNum = "Column",
                                      repId = "Replication")
```


## Gentoypic layout 

Check the layout of the platforms' genotypes. 

```{r}
genotypes_list <- as.character(unique(endpoint$Genotype))

plot(timePoint_endpoint,
     plotType = "layout",
     highlight =  genotypes_list,
     showGeno = FALSE)
```

## 1. endpoint
### Comparisons between raw and cleaned data

#### View timePoint object.

```{r}
summary(timePoint_endpoint)
getTimePoints(timePoint_endpoint)
```

#### Count the number of observations per trait.

```{r}
traits <- variables

for (trait_name in traits) {
  print(paste("How many data observations for", trait_name))
  num_observations <- countValid(timePoint_endpoint, trait_name)
  print(num_observations)
}

for (trait_name in traits) {
  print(paste("How many cleaned data observations for", trait_name))
  num_observations <- countValid(timePoint_endpoint_clean, trait_name)
  print(num_observations)
}
```

#### Check the heatmap of the data at harvest

```{r}
for (trait_name in traits) {
  plot(timePoint_endpoint,
     plotType = "layout",
     timePoints = 1,
     traits = trait_name)
}

for (trait_name in traits) {
  plot(timePoint_endpoint_clean,
     plotType = "layout",
     timePoints = 1,
     traits = trait_name)
}

```


