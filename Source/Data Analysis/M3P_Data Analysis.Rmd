---
title: "M3P Data Analysis"
author: "Elise"
date: "`r Sys.Date()`"
output: 
  html_document:
    toc: true
    toc_float:
      collapsed: false
      smooth_scroll: false 
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_knit$set(root.dir = "C:/Users/elise/Documents/Mémoire/Main/Data/Templates/M3P")
```

Set the right working directory.

```{r}
setwd("C:/Users/elise/Documents/Mémoire/Main/Data/Templates/M3P")
```


```{r echo=TRUE, , include=FALSE}
rm(list = ls())

WDIR <- "C:/Users/elise/Documents/Mémoire/Main/Data"
subdir <- 'Extracted'
datadir <- sprintf( '%s/%s', WDIR, subdir)

library(statgenHTP)
library(ggplot2)
library(gridExtra)
library(dplyr)
library(lubridate)
library(readxl)
library(janitor)
library(flextable)
library(skimr)
library(rstatix)
library(visreg)
library(lsmeans)
library(car)
library(scales)
library(viridis)
library(ggforce)
library(asreml)
library(patchwork)
library(lme4)
library(lmerTest)
library(desplot)
# Import functions
source("~/Mémoire/Main/Source/functions.R")
```

# Data importation

Import the data sets extracted from the Data Preparation R Markdown.

```{r}
list.files()

plant_info <- read.table("plant_info.txt", header = TRUE, sep = "\t")
endpoint <- read.table("endpoint.txt", header = TRUE, sep = "\t")
timeseries <- read.table("timeseries.txt", header = TRUE, sep = "\t")
timeseries_Plant_emergence <- read.table("timeseries_Plant_emergence.txt", header = TRUE, sep = "\t")
timeseries_Plant_transpiration <- read.table("timeseries_Plant_transpiration.txt", header = TRUE, sep = "\t")
timeseries_Soil_water_potential <- read.table("timeseries_Soil_water_potential.txt", header = TRUE, sep = "\t")
timeseries_Ligulated_leaf_number <- read.table("timeseries_Ligulated_leaf_number.txt", header = TRUE, sep = "\t")
timeseries_Water <- read.table("timeseries_Water.txt", header = TRUE, sep = "\t")
timeseries_Leaf_number <- read.table("timeseries_Leaf_number.txt", header = TRUE, sep = "\t")
S_timeseries <- read.table("S_timeseries.txt", header = TRUE, sep = "\t")
```

Convert the columns to factor and date formats.

```{r}
# plant_info
plant_info <- lapply(plant_info, factor)

# endpoint
matching_cols <- intersect(names(endpoint), names(plant_info))
endpoint[, matching_cols] <- lapply(endpoint[, matching_cols], factor)
endpoint$Date <- date(endpoint$Date)
endpoint$Timestamp <- NA

# timeseries_Plant_transpiration
matching_cols <- intersect(names(timeseries_Plant_transpiration), names(plant_info))
timeseries_Plant_transpiration[, matching_cols] <- lapply(timeseries_Plant_transpiration[, matching_cols], factor)
timeseries_Plant_transpiration$Timestamp <- as.POSIXct(timeseries_Plant_transpiration$Timestamp, format = "%Y-%m-%d %H:%M:%S")
timeseries_Plant_transpiration$Date <- date(timeseries_Plant_transpiration$Date)

# timeseries_Leaf_number
matching_cols <- intersect(names(timeseries_Leaf_number), names(plant_info))
timeseries_Leaf_number[, matching_cols] <- lapply(timeseries_Leaf_number[, matching_cols], factor)
timeseries_Leaf_number$Timestamp <- as.POSIXct(timeseries_Leaf_number$Timestamp, format = "%Y-%m-%d %H:%M:%S")
timeseries_Leaf_number$Date <- date(timeseries_Leaf_number$Date)

# timeseries_Soil_water_potential
matching_cols <- intersect(names(timeseries_Soil_water_potential), names(plant_info))
timeseries_Soil_water_potential[, matching_cols] <- lapply(timeseries_Soil_water_potential[, matching_cols], factor)
timeseries_Soil_water_potential$Timestamp <- as.POSIXct(timeseries_Soil_water_potential$Timestamp, format = "%Y-%m-%d %H:%M:%S")
timeseries_Soil_water_potential$Date <- date(timeseries_Soil_water_potential$Date)

# timeseries_Ligulated_leaf_number
matching_cols <- intersect(names(timeseries_Ligulated_leaf_number), names(plant_info))
timeseries_Ligulated_leaf_number[, matching_cols] <- lapply(timeseries_Ligulated_leaf_number[, matching_cols], factor)
timeseries_Ligulated_leaf_number$Timestamp <- as.POSIXct(timeseries_Ligulated_leaf_number$Timestamp, format = "%Y-%m-%d %H:%M:%S")
timeseries_Ligulated_leaf_number$Date <- date(timeseries_Ligulated_leaf_number$Date)

# timeseries_Water
matching_cols <- intersect(names(timeseries_Water), names(plant_info))
timeseries_Water[, matching_cols] <- lapply(timeseries_Water[, matching_cols], factor)
timeseries_Water$Timestamp <- as.POSIXct(timeseries_Water$Timestamp, format = "%Y-%m-%d %H:%M:%S")
timeseries_Water$Date <- date(timeseries_Water$Date)

# timeseries_Plant_emergence
matching_cols <- intersect(names(timeseries_Plant_emergence), names(plant_info))
timeseries_Plant_emergence[, matching_cols] <- lapply(timeseries_Plant_emergence[, matching_cols], factor)
timeseries_Plant_emergence$Timestamp <- as.POSIXct(timeseries_Plant_emergence$Timestamp, format = "%Y-%m-%d %H:%M:%S")
timeseries_Plant_emergence$Date <- date(timeseries_Plant_emergence$Date)

# timeseries
matching_cols <- intersect(names(timeseries), names(plant_info))
timeseries[, matching_cols] <- lapply(timeseries[, matching_cols], factor)
timeseries$Timestamp <- as.POSIXct(timeseries$Timestamp, format = "%Y-%m-%d %H:%M:%S")
timeseries$Date <- date(timeseries$Date)

# S_timeseries
matching_cols <- intersect(names(S_timeseries), names(plant_info))
S_timeseries[, matching_cols] <- lapply(S_timeseries[, matching_cols], factor)
S_timeseries$Timestamp <- as.POSIXct(S_timeseries$Timestamp, format = "%Y-%m-%d %H:%M:%S")
S_timeseries$Date <- date(S_timeseries$Date)

# T_timeseries
# No data
```

Collect the variables of every data template and print the names of the variables. This serves as a double check.

```{r}
platform <- "M3P"

# endpoint
df <- endpoint[,colSums(is.na(endpoint))<nrow(endpoint)]
genotype_index <- which(colnames(df) == "Genotype")
variables <- "DW_plant_g"

# timeseries
variables_t <- c("Plant_biomass_g", "Leaf_number", "Ligulated_leaf_number", "Plant_emergence", "Plant_transpiration", "Soil_water_potential", "Water")

# S_timeseries
df_S_timeseries <- S_timeseries[,colSums(is.na(S_timeseries))<nrow(S_timeseries)]
genotype_index <- which(colnames(df_S_timeseries) == "Genotype")
variables_S <- colnames(df_S_timeseries[, c(5:(genotype_index - 1))]) # We remove the three first columns that are "Unit.ID","Time" and "Date"

# T_timeseries
# No data for M3P

print(paste(platform, ": The variables for endpoint are", paste(variables, collapse = ", "), sep = " "))
print(paste(platform, ": The variables for timeseries are", paste(variables_t, collapse = ", "), sep = " "))
print(paste(platform, ": The variables for S_timeseries are", paste(variables_S, collapse = ", "), sep = " "))
```

Add a column Plant_type with three levels, H L and T.
This variable is useful to test for heterosis effects.

```{r}
endpoint$Plant_type <- substr(endpoint$Genotype, nchar(as.character(endpoint$Genotype)), nchar(as.character(endpoint$Genotype)))
timeseries$Plant_type <- substr(timeseries$Genotype, nchar(as.character(timeseries$Genotype)), nchar(as.character(timeseries$Genotype)))

timeseries_Plant_transpiration$Plant_type <- substr(timeseries_Plant_transpiration$Genotype, nchar(as.character(timeseries_Plant_transpiration$Genotype)), nchar(as.character(timeseries_Plant_transpiration$Genotype)))
timeseries_Water$Plant_type <- substr(timeseries_Water$Genotype, nchar(as.character(timeseries_Water$Genotype)), nchar(as.character(timeseries_Water$Genotype)))
timeseries_Soil_water_potential$Plant_type <- substr(timeseries_Soil_water_potential$Genotype, nchar(as.character(timeseries_Soil_water_potential$Genotype)), nchar(as.character(timeseries_Soil_water_potential$Genotype)))
timeseries_Plant_emergence$Plant_type <- substr(timeseries_Plant_emergence$Genotype, nchar(as.character(timeseries_Plant_emergence$Genotype)), nchar(as.character(timeseries_Plant_emergence$Genotype)))
timeseries_Ligulated_leaf_number$Plant_type <- substr(timeseries_Ligulated_leaf_number$Genotype, nchar(as.character(timeseries_Ligulated_leaf_number$Genotype)), nchar(as.character(timeseries_Ligulated_leaf_number$Genotype)))
timeseries_Leaf_number$Plant_type <- substr(timeseries_Leaf_number$Genotype, nchar(as.character(timeseries_Leaf_number$Genotype)), nchar(as.character(timeseries_Leaf_number$Genotype)))

S_timeseries$Plant_type <- substr(S_timeseries$Genotype, nchar(as.character(S_timeseries$Genotype)), nchar(as.character(S_timeseries$Genotype)))
```

# 1. Endpoint dataframe
## A. Exploration of data 
### Exploration tables using the rstatix, janitor and skimr packages
```{r}
endpoint %>% 
  count(Genotype)

endpoint %>%
  tabyl(Genotype, Column) %>%
  adorn_totals("row") %>%
  adorn_percentages("row") %>%
  adorn_pct_formatting() %>%
  adorn_ns() %>%
  adorn_title("combined")

endpoint %>%
  tabyl(Genotype, Row) %>%
  adorn_totals("row") %>%
  adorn_percentages("row") %>%
  adorn_pct_formatting() %>%
  adorn_ns() %>%
  adorn_title("combined")

endpoint %>% 
  count(Genotype)

get_summary_stats(data = endpoint, 
                  variables,
                  type = "common")

```

```{r}
skim(endpoint[variables])
```

### Data visualization

Using several functions that are located in the functions.R script

#### Boxplots

```{r}
create_boxplots(endpoint, variables, "Genotype")
create_boxplots(endpoint, variables, "Plant_type")
```

#### Correlation plots

```{r}
print(paste0("No data for ", platform))
```

## B. Normality hypothesis and outlier detection

Test for normality hypothesis and plot density histogram.
The red curve is the normal distribution, the blue dotted curve is the data density curve. 

```{r}
normality_results <- normality_test_histogram(endpoint)
```

Remove the outliers, replacing them with NULL values and normality visual verification.

The function detect_replace_ouliers_by_genotype checks for outlying values, using the Tukey method.

Then run the function on all variables of the dataset. 

```{r}
endpoint_clean <- endpoint
# Run the function on the dataset for all the variables
endpoint_clean <- detect_replace_outliers_by_genotype(endpoint_clean)
```

### Boxplots after outlier detection

```{r}
create_boxplots(endpoint_clean, variables, "Genotype")
create_boxplots(endpoint_clean, variables, "Plant_type")
```

### Violin and sina plots after outlier detection

```{r}
create_violin_plots(endpoint_clean, variables, "Genotype")
create_violin_plots(endpoint_clean, variables, "Plant_type")
```

### Exploration statistics for the variables after outlier detection

```{r}
skim(endpoint_clean[variables])

for (var in variables) {
  cat("\nSummary for:", var, "\n")
  endpoint_clean %>% 
    group_by(Genotype) %>% 
    summarize(mean    = mean(get(var), na.rm = TRUE),
              std.dev = sd(get(var), na.rm = TRUE),
              n_missing  = sum(is.na(get(var)))) %>% 
    arrange(desc(mean)) %>%
    print(n = Inf)
}
```

# 2. Exploration of the timeseries data
In this part, we look at the timeseries, S_timeseries and T_timeseries datasets, also using several functions, located in the functions.R script. 

## Number of data observations per day for the traits of the timeseries datasets

```{r}
h1 <- ggplot(timeseries, aes(x = Date)) +
  geom_bar(aes(fill = Genotype), position = "stack", width = 0.96) +
  scale_fill_viridis_d(option = "D") +
  labs(x = "Date", y = "Number of observations", title = "Observations per day for Plant_biomass_g") +
  scale_y_continuous(breaks = seq(from = 0, to = 325, by = 25)) +
  scale_x_date(date_breaks = "2 days", date_labels = "%d-%m-%Y") + 
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
        panel.grid.major.x = element_line(color = "lightgray", size = 0.5),
        panel.grid.minor.x = element_blank())



h2 <- ggplot(timeseries_Leaf_number, aes(x = Date)) +
  geom_bar(aes(fill = Genotype), position = "stack", width = 0.96) +
  scale_fill_viridis_d(option = "D") +
  labs(x = "Date", y = "Number of observations", title = "Observations per day for Leaf_number") +
  scale_y_continuous(breaks = seq(from = 0, to = 325, by = 25)) +
  scale_x_date(date_breaks = "2 days", date_labels = "%d-%m-%Y") + 
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
        panel.grid.major.x = element_line(color = "lightgray", size = 0.5),
        panel.grid.minor.x = element_blank())

h3 <- ggplot(timeseries_Ligulated_leaf_number, aes(x = Date)) +
  geom_bar(aes(fill = Genotype), position = "stack", width = 0.96) +
  scale_fill_viridis_d(option = "D") +
  labs(x = "Date", y = "Number of observations", title = "Observations per day for Ligulated_leaf_number") +
  scale_y_continuous(breaks = seq(from = 0, to = 325, by = 25)) +
  scale_x_date(date_breaks = "2 days", date_labels = "%d-%m-%Y") + 
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
        panel.grid.major.x = element_line(color = "lightgray", size = 0.5),
        panel.grid.minor.x = element_blank())

h4 <- ggplot(timeseries_Plant_emergence, aes(x = Date)) +
  geom_bar(aes(fill = Genotype), position = "stack", width = 0.96) +
  scale_fill_viridis_d(option = "D") +
  labs(x = "Date", y = "Number of observations", title = "Observations per day for Plant_emergence") +
  scale_y_continuous(breaks = seq(from = 0, to = 325, by = 25)) +
  scale_x_date(date_breaks = "2 days", date_labels = "%d-%m-%Y") + 
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
        panel.grid.major.x = element_line(color = "lightgray", size = 0.5),
        panel.grid.minor.x = element_blank())

h5 <- ggplot(timeseries_Plant_transpiration, aes(x = Date)) +
  geom_bar(aes(fill = Genotype), position = "stack", width = 0.96) +
  scale_fill_viridis_d(option = "D") +
  labs(x = "Date", y = "Number of observations", title = "Observations per day for Plant_transpiration") +
  scale_y_continuous(breaks = seq(from = 0, to = 325, by = 25)) +
  scale_x_date(date_breaks = "2 days", date_labels = "%d-%m-%Y") + 
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
        panel.grid.major.x = element_line(color = "lightgray", size = 0.5),
        panel.grid.minor.x = element_blank())

h6 <- ggplot(timeseries_Soil_water_potential, aes(x = Date)) +
  geom_bar(aes(fill = Genotype), position = "stack", width = 0.96) +
  scale_fill_viridis_d(option = "D") +
  labs(x = "Date", y = "Number of observations", title = "Observations per day for Soil_water_potential") +
  scale_y_continuous(breaks = seq(from = 0, to = 325, by = 25)) +
  scale_x_date(date_breaks = "2 days", date_labels = "%d-%m-%Y") + 
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
        panel.grid.major.x = element_line(color = "lightgray", size = 0.5),
        panel.grid.minor.x = element_blank())

h7 <- ggplot(timeseries_Water, aes(x = Date)) +
  geom_bar(aes(fill = Genotype), position = "stack", width = 0.96) +
  scale_fill_viridis_d(option = "D") +
  labs(x = "Date", y = "Number of observations", title = "Observations per day for Water") +
  scale_y_continuous(breaks = seq(from = 0, to = 325, by = 25)) +
  scale_x_date(date_breaks = "2 days", date_labels = "%d-%m-%Y") + 
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
        panel.grid.major.x = element_line(color = "lightgray", size = 0.5),
        panel.grid.minor.x = element_blank())


h8 <- ggplot(S_timeseries, aes(x = Date)) +
  geom_bar(aes(fill = Genotype), position = "stack", width = 0.96) +
  scale_fill_viridis_d(option = "D") +
  labs(x = "Date", y = "Number of observations", title = "Observations per day for S_timeseries") +
  scale_y_continuous(breaks = seq(from = 0, to = 325, by = 25)) +
  scale_x_date(date_breaks = "2 days", date_labels = "%d-%m-%Y") + 
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
        panel.grid.major.x = element_line(color = "lightgray", size = 0.5),
        panel.grid.minor.x = element_blank())
h1
h2
h3
h4
h5
h6
h7
h8

```

## A. Exploration of the timeseries dataframe 

Scatter plots by Genotype

```{r}
plot_scatter_by_genotype(timeseries, variables_t[1], "EPPN20_T")
plot_scatter_by_genotype(timeseries_Leaf_number, variables_t[2], "EPPN20_T")
plot_scatter_by_genotype(timeseries_Ligulated_leaf_number, variables_t[3], "EPPN20_T")
plot_scatter_by_genotype(timeseries_Plant_emergence, variables_t[4], "EPPN20_T")
plot_scatter_by_genotype(timeseries_Plant_transpiration, variables_t[5], "EPPN20_T")
plot_scatter_by_genotype(timeseries_Soil_water_potential, variables_t[6], "EPPN20_T")
# Problem for water timeseries data
```

Scatterplots for all genotypes by Plant type (Hybride, Line, EPPN20_T) with smooth line.

```{r}
plot_scatter_with_smooth(timeseries, variables_t[1])
plot_scatter_with_smooth(timeseries_Leaf_number, variables_t[2])
plot_scatter_with_smooth(timeseries_Ligulated_leaf_number, variables_t[3])
plot_scatter_with_smooth(timeseries_Plant_emergence, variables_t[4])
plot_scatter_with_smooth(timeseries_Plant_transpiration, variables_t[5])
plot_scatter_with_smooth(timeseries_Soil_water_potential, variables_t[6])
# Problem for water timeseries data
```

Scatter plots for all genotypes by water treatment
```{r}

plot_scatter_with_smooth_water(timeseries, variables_t[1])
plot_scatter_with_smooth_water(timeseries_Leaf_number, variables_t[2])
plot_scatter_with_smooth_water(timeseries_Ligulated_leaf_number, variables_t[3])
plot_scatter_with_smooth_water(timeseries_Plant_emergence, variables_t[4])
plot_scatter_with_smooth_water(timeseries_Plant_transpiration, variables_t[5])
plot_scatter_with_smooth_water(timeseries_Soil_water_potential, variables_t[6])
# Problem for water timeseries data
```


## B. Exploration of the S_timeseries dataframe

Scatter plots by Genotype

```{r}
plot_scatter_by_genotype(S_timeseries, variables_S, "EPPN20_T")
```

Scatterplots for all genotypes by Plant type (Hybride, Line, EPPN20_T) with smooth line.

```{r}
plot_scatter_with_smooth(S_timeseries, variables_S)
```

Scatter plots for all genotypes by water treatment

```{r}
plot_scatter_with_smooth_water(S_timeseries, variables_S)
```


## C. Exploration of the T_timeseries dataframe

Scatter plots by Genotype

```{r}
print(paste0("No data for", platform))
```

Scatterplots for all genotypes by Plant type (Hybride, Line, EPPN20_T) with smooth line.

```{r}
print(paste0("No data for", platform))
```

Scatter plots for all genotypes by water treatment
```{r}
print(paste0("No data for", platform))
```


