---
title: "SPPU Data Analysis"
author: "Elise"
date: "`r Sys.Date()`"
output: 
  html_document:
    toc: true
    toc_float:
      collapsed: false
      smooth_scroll: false 
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_knit$set(root.dir = "C:/Users/elise/Documents/Mémoire/Main/Data/Templates/SPPU")
```

Set the right working directory.

```{r}
setwd("C:/Users/elise/Documents/Mémoire/Main/Data/Templates/SPPU")
```


```{r echo=TRUE, , include=FALSE}
rm(list = ls())

WDIR <- "C:/Users/elise/Documents/Mémoire/Main/Data"
subdir <- 'Extracted'
datadir <- sprintf( '%s/%s', WDIR, subdir)

library(statgenHTP)
library(ggplot2)
library(gridExtra)
library(dplyr)
library(lubridate)
library(readxl)
library(janitor)
library(flextable)
library(skimr)
library(rstatix)
library(visreg)
library(lsmeans)
library(car)
library(scales)
library(viridis)
library(ggforce)
library(asreml)
library(patchwork)
library(lme4)
library(lmerTest)
library(desplot)
# Import functions
source("~/Mémoire/Main/Source/functions.R")
```

# Data importation

Import the data sets extracted from the Data Preparation R Markdown.

```{r}
list.files()

plant_info <- read.table("plant_info.txt", header = TRUE, sep = "\t")
S_timeseries <- read.table("S_timeseries.txt", header = TRUE, sep = "\t")
T_timeseries <- read.table("T_timeseries.txt", header = TRUE, sep = "\t")
```

Convert the columns to factor and date formats.

```{r}
# plant_info
plant_info <- lapply(plant_info, factor)

# S_timeseries
matching_cols <- intersect(names(S_timeseries), names(plant_info))
S_timeseries[, matching_cols] <- lapply(S_timeseries[, matching_cols], factor)
S_timeseries$Timestamp <- as.POSIXct(S_timeseries$Timestamp, format = "%Y-%m-%d %H:%M:%S")
S_timeseries$Date <- date(S_timeseries$Date)

# T_timeseries
matching_cols <- intersect(names(T_timeseries), names(plant_info))
T_timeseries[, matching_cols] <- lapply(T_timeseries[, matching_cols], factor)
T_timeseries$Timestamp <- as.POSIXct(T_timeseries$Timestamp, format = "%Y-%m-%d %H:%M:%S")
T_timeseries$Date <- date(T_timeseries$Date)
```

Collect the variables of every data template and print the names of the variables. This serves as a double check.

```{r}
platform <- "SPPU"

# S_timeseries
df_S_timeseries <- S_timeseries[,colSums(is.na(S_timeseries))<nrow(S_timeseries)]
genotype_index <- which(colnames(df_S_timeseries) == "Genotype")
variables_S <- colnames(df_S_timeseries[, c(5:(genotype_index - 1))]) # We remove the three first columns that are "Unit.ID","Time" and "Date"

# T_timeseries
df_T_timeseries <- T_timeseries[,colSums(is.na(T_timeseries))<nrow(T_timeseries)]
genotype_index <- which(colnames(df_T_timeseries) == "Genotype")
variables_T <- colnames(df_T_timeseries[, c(5:(genotype_index - 1))]) # We remove the three first columns that are "Unit.ID","Time" and "Date"

print(paste(platform, ": The variables for S_timeseries are", paste(variables_S, collapse = ", "), sep = " "))
print(paste(platform, ": The variables for T_timeseries are", paste(variables_T, collapse = ", "), sep = " "))
```

Add a column Plant_type with three levels, H L and T.
This variable is useful to test for heterosis effects.

```{r}
S_timeseries$Plant_type <- substr(S_timeseries$Genotype, nchar(as.character(S_timeseries$Genotype)), nchar(as.character(S_timeseries$Genotype)))
T_timeseries$Plant_type <- substr(T_timeseries$Genotype, nchar(as.character(T_timeseries$Genotype)), nchar(as.character(T_timeseries$Genotype)))
```

# 1. Endpoint dataframe
## A. Exploration of data 
### Exploration tables using the rstatix, janitor and skimr packages
```{r}
print(paste0("No data for ", platform))
```

```{r}
print(paste0("No data for", platform))
```

### Data visualization

Using several functions that are located in the functions.R script

#### Boxplots

```{r}
print(paste0("No data for", platform))
```

#### Correlation plots

```{r}
print(paste0("No data for", platform))
```

## B. Normality hypothesis and outlier detection

Test for normality hypothesis and plot density histogram.
The red curve is the normal distribution, the blue dotted curve is the data density curve. 

```{r}
print(paste0("No data for", platform))
```

Remove the outliers, replacing them with NULL values and normality visual verification.

The function detect_replace_ouliers_by_genotype checks for outlying values, using the Tukey method.

Then run the function on all variables of the dataset. 

```{r}
print(paste0("No data for", platform))
```

### Boxplots after outlier detection

```{r}
print(paste0("No data for", platform))
```

### Violin and sina plots after outlier detection

```{r}
print(paste0("No data for", platform))
```

### Exploration statistics for the variables after outlier detection

```{r}
print(paste0("No data for", platform))
```

# 2. Exploration of the timeseries data
In this part, we look at the timeseries, S_timeseries and T_timeseries datasets, also using several functions, located in the functions.R script. 

## Number of data observations per day for the traits of the timeseries datasets

```{r}

h2 <- ggplot(S_timeseries, aes(x = Date)) +
  geom_bar(aes(fill = Genotype), position = "stack", width = 0.96) +
  scale_fill_viridis_d(option = "D") +
  labs(x = "Date", y = "Number of observations", title = "Observations per day for S_timeseries") +
  scale_y_continuous(breaks = seq(from = 0, to = 325, by = 25)) +
  scale_x_date(date_breaks = "2 days", date_labels = "%d-%m-%Y") + 
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
        panel.grid.major.x = element_line(color = "lightgray", size = 0.5),
        panel.grid.minor.x = element_blank())

h3 <- ggplot(T_timeseries, aes(x = Date)) +
  geom_bar(aes(fill = Genotype), position = "stack", width = 0.96) +
  scale_fill_viridis_d(option = "D") +
  labs(x = "Date", y = "Number of observations", title = "Observations per day for T_timeseries") +
  scale_y_continuous(breaks = seq(from = 0, to = 325, by = 25)) +
  scale_x_date(date_breaks = "2 days", date_labels = "%d-%m-%Y") + 
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
        panel.grid.major.x = element_line(color = "lightgray", size = 0.5),
        panel.grid.minor.x = element_blank())

h2
h3
```

## A. Exploration of the timeseries dataframe 

Scatter plots by Genotype

```{r}
print(paste0("No data for", platform))
```

Scatterplots for all genotypes by Plant type (Hybride, Line, EPPN20_T) with smooth line.

```{r}
print(paste0("No data for", platform))
```

Scatter plots for all genotypes by water treatment
```{r}
print(paste0("No data for", platform))
```


## B. Exploration of the S_timeseries dataframe

Scatter plots by Genotype

```{r}
plot_scatter_by_genotype(S_timeseries, variables_S, "EPPN_T")
```

Scatterplots for all genotypes by Plant type (Hybride, Line, EPPN20_T) with smooth line.

```{r}
plot_scatter_with_smooth(S_timeseries, variables_S)
```

Scatter plots for all genotypes by water treatment
```{r}
plot_scatter_with_smooth_water(S_timeseries, variables_S)
```


## C. Exploration of the T_timeseries dataframe

Scatter plots by Genotype

```{r}
plot_scatter_by_genotype(T_timeseries, variables_T, "EPPN_T")
```

Scatterplots for all genotypes by Plant type (Hybride, Line, EPPN20_T) with smooth line.

```{r}
plot_scatter_with_smooth(T_timeseries, variables_T)
```

Scatter plots for all genotypes by water treatment
```{r}
plot_scatter_with_smooth_water(T_timeseries, variables_T)
```


